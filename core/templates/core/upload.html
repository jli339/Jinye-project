<!-- upload.htmlï¼šåŠ¨æ€ç›®å½•æ ‘é€‰æ‹©å™¨ + æ–‡ä»¶ä¸Šä¼ è¡¨å• -->
<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>ä¸Šä¼ æ–‡ä»¶</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/jstree/3.3.12/themes/default/style.min.css"/>
    <style>
        #folderTreeWrapper {
            border: 1px solid #ccc;
            padding: 10px;
            max-height: 300px;
            overflow-y: auto;
        }

        #folderTree {
            margin-top: 5px;
        }
    </style>
</head>
<body>
<h2>ä¸Šä¼ æ–‡ä»¶</h2>
<form method="post" enctype="multipart/form-data">
    {% csrf_token %}
    {{ form.file.label_tag }} {{ form.file }}<br><br>
    {{ form.name.label_tag }} {{ form.name }}<br><br>
    {{ form.description.label_tag }} {{ form.description }}<br><br>
    {{ form.category.label_tag }} {{ form.category }}<br><br>
    {{ form.readable_roles.label_tag }} {{ form.readable_roles }}<br><br>
    {{ form.editable_roles.label_tag }} {{ form.editable_roles }}<br><br>

    <label for="target_path">é€‰æ‹©ç›®æ ‡ä¿å­˜è·¯å¾„ï¼š</label>
    <div id="folderTreeWrapper">
        <div id="folderTree"></div>
    </div>
    <input type="hidden" id="target_path" name="target_path">
    <p>å½“å‰é€‰æ‹©ï¼š<span id="selectedPath">(æœªé€‰æ‹©)</span></p>

    <button type="submit">ä¸Šä¼ </button>
</form>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jstree/3.3.12/jstree.min.js"></script>
<script>
    // è·å–ç›®å½•æ ‘æ•°æ®å¹¶æ¸²æŸ“
    $(function () {
        fetch("/api/folder_tree/")
            .then(res => res.json())
            .then(data => {
                console.log("âœ… åŸå§‹ç›®å½•æ ‘æ•°æ®ï¼š", data);  // âœ… è°ƒè¯•ç‚¹ 1

                // æ ¼å¼è½¬æ¢
                const treeData = formatForJsTree(data);
                console.log("âœ… è½¬æ¢åçš„ treeDataï¼š", treeData);  // âœ… è°ƒè¯•ç‚¹ 2

                $('#folderTree').jstree({'core': {'data': treeData}});

                // ç›‘å¬ç‚¹å‡»äº‹ä»¶
                $('#folderTree').on("select_node.jstree", function (e, data) {
                    console.log("âœ… èŠ‚ç‚¹ç‚¹å‡»äº‹ä»¶è§¦å‘ï¼š", data);  // âœ… è°ƒè¯•ç‚¹ 3
                    console.log("ğŸ“Œ åŸå§‹ node æ•°æ®ï¼š", data.node);
                    console.log("ğŸ“Œ node.originalï¼š", data.node.data);
                    console.log("ğŸ“Œ node.original.pathï¼š", data.node.data?.path);
                    console.dir(data.node); // ç”¨ dir çœ‹ç»“æ„ä½“

                    const selectedPath = data.node.data?.path;
                    if (selectedPath) {
                        $('#target_path').val(selectedPath);
                        $('#selectedPath').text(selectedPath);
                        console.log("âœ… é€‰ä¸­è·¯å¾„ï¼š", selectedPath);  // âœ… è°ƒè¯•ç‚¹ 4
                    } else {
                        alert("âš ï¸ å½“å‰èŠ‚ç‚¹æœªç»‘å®š path å­—æ®µï¼");
                    }
                });
            })
            .catch(err => {
                console.error("âŒ è·å–ç›®å½•æ ‘å¤±è´¥ï¼š", err);
            });
    });

    // è½¬æ¢åç«¯ç»“æ„ä¸º jsTree æ ¼å¼
    function formatForJsTree(nodes) {
        return nodes.map(node => ({
            text: node.label,
        
            data: {path: node.path},  // âœ… æ·»åŠ  original ç»“æ„
            children: formatForJsTree(node.children || []),
            state: {opened: true},
        }));
    }
</script>